<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>CTF MOVEment with Aptos Dec 2022 Writeup - Qi Qin</title><meta name=Description content="Writeup for CTF MOVEment with Aptos Dec 2022"><meta property="og:title" content="CTF MOVEment with Aptos Dec 2022 Writeup"><meta property="og:description" content="Writeup for CTF MOVEment with Aptos Dec 2022"><meta property="og:type" content="article"><meta property="og:url" content="https://leoq7.com/2022/12/CTF-Movement-Aptos/"><meta property="og:image" content="https://leoq7.com/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-12-14T17:55:28+08:00"><meta property="article:modified_time" content="2022-12-14T17:55:28+08:00"><meta property="og:site_name" content="Qi Qin"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://leoq7.com/logo.png"><meta name=twitter:title content="CTF MOVEment with Aptos Dec 2022 Writeup"><meta name=twitter:description content="Writeup for CTF MOVEment with Aptos Dec 2022"><meta name=application-name content="Qi Qin"><meta name=apple-mobile-web-app-title content="Qi Qin"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://leoq7.com/2022/12/CTF-Movement-Aptos/><link rel=prev href=https://leoq7.com/2022/12/PBCTF-Move-VM/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"CTF MOVEment with Aptos Dec 2022 Writeup","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/leoq7.com\/2022\/12\/CTF-Movement-Aptos\/"},"genre":"posts","keywords":"Web3, CTF, Move","wordcount":1490,"url":"https:\/\/leoq7.com\/2022\/12\/CTF-Movement-Aptos\/","datePublished":"2022-12-14T17:55:28+08:00","dateModified":"2022-12-14T17:55:28+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Qi Qin"},"description":"Writeup for CTF MOVEment with Aptos Dec 2022"}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':'auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark')&&document.body.setAttribute('theme','dark')</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Qi Qin">Qi Qin</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/>About Me </a><a class=menu-item href=/publications/>Publications </a><a class=menu-item href=/contact/>Contact </a><a class=menu-item href=/posts/>Blogs </a><a class=menu-item href=/links/>Links </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop><input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Qi Qin">Qi Qin</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/ title>About Me</a><a class=menu-item href=/publications/ title>Publications</a><a class=menu-item href=/contact/ title>Contact</a><a class=menu-item href=/posts/ title>Blogs</a><a class=menu-item href=/links/ title>Links</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">CTF MOVEment with Aptos Dec 2022 Writeup</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://leoq7.com title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Qi Qin</a></span>&nbsp;<span class=post-category>included in <a href=/categories/Web3/><i class="far fa-folder fa-fw" aria-hidden=true></i>Web3</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-12-14>2022-12-14</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1490 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;7 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#preface>Preface</a></li><li><a href=#challenge-1-checkin>Challenge 1: checkin</a><ul><li><a href=#target-contract>Target contract</a></li><li><a href=#solution>Solution</a></li></ul></li><li><a href=#challenge-2-hello-move>Challenge 2: hello move</a><ul><li><a href=#target-contract-1>Target contract</a><ul><li><a href=#q1-hash>q1: hash</a></li><li><a href=#q2-discrete_log>q2: discrete_log</a></li><li><a href=#q3-add>q3: add</a></li></ul></li><li><a href=#exploit-contract>Exploit contract</a></li></ul></li><li><a href=#challenge-3-swap-empty>Challenge 3: swap empty</a><ul><li><a href=#target-contract-2>Target contract</a></li><li><a href=#vulnerability>Vulnerability</a></li><li><a href=#exploit-contract-1>Exploit contract</a></li><li><a href=#possible-fix>Possible fix</a></li></ul></li><li><a href=#challenge-4-simple-swap>Challenge 4: simple swap</a><ul><li><a href=#target-contract-3>Target contract</a></li><li><a href=#vulnerability-1>Vulnerability</a></li><li><a href=#exploit-contract-2>Exploit contract</a></li><li><a href=#possible-fix-1>Possible fix</a></li></ul></li><li><a href=#challenge-5-move-lock-v2>Challenge 5: move lock v2</a><ul><li><a href=#target-contract-4>Target contract</a></li><li><a href=#vulnerability-2>Vulnerability</a></li><li><a href=#exploit-contract-3>Exploit contract</a></li></ul></li></ul></nav></div></div><div class=content id=content><h2 id=preface>Preface</h2><p>It&rsquo;s been half a year since I last wrote a blog. During that time, I&rsquo;ve learned a lot about Web3 security, including Solana and Aptos. Last weekend, I participated in the CTF MOVEment with Aptos Dec 2022 jointly organized by MoveBit, Aptos, ChainFlag and OtterSec, and scored two first-bloods and two second-bloods in the four challenges except the sanity-check, ranking first in the end. In this post, I will briefly introduce the solutions to the five challenges.</p><h2 id=challenge-1-checkin>Challenge 1: checkin</h2><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>Challenge Info<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content><ul><li>Source: <a href=https://github.com/movebit/ctfmovement-1>https://github.com/movebit/ctfmovement-1</a></li><li>Link: http://47.243.227.164:20000/web/</li><li>Score: 100</li></ul></div></div></div><h3 id=target-contract>Target contract</h3><p>The challenge 1 is a sanity-check to let players get familiar with how to use <code>aptos-cli</code> to communicate with the private chain where the challenge contract is deployed. There is a <code>get_flag</code> function in the contract, and once it&rsquo;s called it will emit an <code>Flag</code> event.</p><h3 id=solution>Solution</h3><p>After initializing an account and invoking the <code>get_flag</code> function via <code>aptos-cli</code>, we can submit the transaction hash to the challenge website, the server will check whether this transaction triggers the <code>Flag</code> event, and if so, the server will return the flag.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>aptos init --assume-yes --network custom --rest-url http://8.218.146.10:9080 --faucet-url http://8.218.146.10:9081
aptos move run --assume-yes --function-id VICTIM_ADDRESS::checkin::get_flag
</code></pre></td></tr></table></div></div><h2 id=challenge-2-hello-move>Challenge 2: hello move</h2><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>Challenge Info<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content><ul><li>Source: <a href=https://github.com/movebit/ctfmovement-2>https://github.com/movebit/ctfmovement-2</a></li><li>Link: http://47.243.227.164:20001/web/</li><li>Score: 200</li></ul></div></div></div><h3 id=target-contract-1>Target contract</h3><p>The challenge 2 is a simple challenge to let players get familiar with the Move language. The contract has five functions: <code>init_challenge</code>, <code>hash</code>, <code>discrete_log</code>, <code>add</code>, <code>pow</code> and <code>get_flag</code>. The <code>init_challenge</code> function is used to initialize the challenge by sending the caller a <code>Challenge</code> object with 5 members, <code>balance=10</code>, <code>q1=false</code>, <code>q2=false</code>, <code>q3=false</code>, and an event handler. <code>q1</code>, <code>q2</code>, <code>q3</code> indicates the solving status of the 3 sub-problems in this challenge, and these status will be checked in the <code>get_flag</code> function.</p><h4 id=q1-hash>q1: hash</h4><p><code>q1</code> will be set to true if we invoke the <code>hash</code> function and provide a <code>guess: vector&lt;u8></code> satisfying <code>len(guess)==4 && keccak256(guess+"move")=="d9ad5396ce1ed307e8fb2a90de7fd01d888c02950ef6852fbc2191d2baf58e79"</code>. This can be solved by writing a simple script to brute-force all the possible guesses, and the answer is <code>good</code>.</p><h4 id=q2-discrete_log>q2: discrete_log</h4><p>In order to set <code>q2</code> to true, we need to provide a <code>guess: u128</code> satisfying <code>pow(10549609011087404693, guess, 18446744073709551616) == 18164541542389285005</code>, which is a classic discrete logarithm problem. We can solve this with <code>discrete_log(18164541542389285005,Mod(10549609011087404693,18446744073709551616))</code> in sage, and the answer is $3123592912467026955$.</p><h4 id=q3-add>q3: add</h4><p>The sub-problem <code>q3</code> is more interesting. Similar to other checked arithmetic implementation, the <a href=https://github.com/move-language/move/blob/main/language/move-vm/runtime/src/interpreter.rs#L1945-L1952 target=_blank rel="noopener noreffer">Shl and Shr operations in Move language</a> will raise an <a href=https://github.com/move-language/move/blob/main/language/move-vm/types/src/values/values_impl.rs#L1568-L1604 target=_blank rel="noopener noreffer">ARITHMETIC_ERROR</a> if the shift amount is greater than or equal to the bit width of the operand as this is a cpu-level undefined behavior. And the <code>Shl</code> operations won&rsquo;t raise <code>ARITHMETIC_ERROR</code> if there is an overflow. So we can shift the current balance $10$ to the left by more than $8$ bits to set the balance to $0$.</p><h3 id=exploit-contract>Exploit contract</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-rust data-lang=rust><span class=n>module</span><span class=w> </span><span class=n>solution</span>::<span class=n>solution2</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>signer</span><span class=p>;</span><span class=w>
</span><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>vector</span><span class=p>;</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>ctfmovement</span>::<span class=n>hello_move</span><span class=p>;</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=n>public</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=n>fun</span><span class=w> </span><span class=n>solve</span><span class=p>(</span><span class=n>account</span>: <span class=kp>&amp;</span><span class=nc>signer</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>        </span><span class=n>hello_move</span>::<span class=n>init_challenge</span><span class=p>(</span><span class=n>account</span><span class=p>);</span><span class=w>
</span><span class=w>        </span><span class=n>hello_move</span>::<span class=n>hash</span><span class=p>(</span><span class=n>account</span><span class=p>,</span><span class=w> </span><span class=n>vector</span><span class=p>[</span><span class=mi>103</span><span class=p>,</span><span class=mi>111</span><span class=p>,</span><span class=mi>111</span><span class=p>,</span><span class=mi>100</span><span class=p>]);</span><span class=w>
</span><span class=w>        </span><span class=n>hello_move</span>::<span class=n>discrete_log</span><span class=p>(</span><span class=n>account</span><span class=p>,</span><span class=w> </span><span class=mi>3123592912467026955</span><span class=p>);</span><span class=w>
</span><span class=w>        </span><span class=n>hello_move</span>::<span class=n>add</span><span class=p>(</span><span class=n>account</span><span class=p>,</span><span class=w> </span><span class=mi>3</span><span class=p>,</span><span class=w> </span><span class=mi>5</span><span class=p>);</span><span class=w>
</span><span class=w>        </span><span class=n>hello_move</span>::<span class=n>add</span><span class=p>(</span><span class=n>account</span><span class=p>,</span><span class=w> </span><span class=mi>3</span><span class=p>,</span><span class=w> </span><span class=mi>5</span><span class=p>);</span><span class=w>
</span><span class=w>        </span><span class=n>hello_move</span>::<span class=n>get_flag</span><span class=p>(</span><span class=n>account</span><span class=p>);</span><span class=w>
</span><span class=w>    </span><span class=p>}</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></td></tr></table></div></div><h2 id=challenge-3-swap-empty>Challenge 3: swap empty</h2><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>Challenge Info<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content><ul><li>Source: <a href=https://github.com/movebit/ctfmovement-3>https://github.com/movebit/ctfmovement-3</a></li><li>Link: http://47.243.227.164:20002/web/</li><li>Score: 200</li></ul></div></div></div><h3 id=target-contract-2>Target contract</h3><p>This target contract implements a very simple swap protocol, which allows users to swap between two tokens <code>Coin1</code> and <code>Coin2</code>. The contract has a <code>get_coin</code> function to let the user get an airdrop of $5$ <code>Coin1</code> and $5$ <code>Coin2</code>, two functions <code>swap_12</code> and <code>swap_21</code> to swap between <code>Coin1</code> and <code>Coin2</code>, and a <code>get_flag</code> function checks whether the amount of <code>Coin1</code> or <code>Coin2</code> in the reserved account is <code>0</code>.</p><h3 id=vulnerability>Vulnerability</h3><p>The vulnerability is the design of the <code>get_amouts_out</code> function. This contract uses a very naive way of calculating the amount of token that can be exchanged based on the ratio of <code>Coin1</code> and <code>Coin2</code> in the reserve account. However, this design is not safe, consider the following POC:</p><ul><li><p>Attacker get $5$ <code>Coin1</code> and $5$ <code>Coin2</code> from airdrop
User: $5$ <code>Coin1</code>, $5$ <code>Coin2</code>; Reserve: $50$ <code>Coin1</code>, $50$ <code>Coin2</code></p></li><li><p>Attacker swap $5$ <code>Coin2</code> to $5\cdot\frac{50}{50}=5$ <code>Coin1</code>
User: $10$ <code>Coin1</code>, $0$ <code>Coin2</code>; Reserve: $45$ <code>Coin1</code>, $55$ <code>Coin2</code></p></li><li><p>Attacker swap $10$ <code>Coin1</code> to $10\cdot\frac{55}{45}=12$ <code>Coin2</code>
User: $0$ <code>Coin1</code>, $12$ <code>Coin2</code>; Reserve: $55$ <code>Coin1</code>, $43$ <code>Coin2</code></p></li><li><p>Attacker swap $12$ <code>Coin2</code> to $12\cdot\frac{55}{43}=15$ <code>Coin1</code>
User: $15$ <code>Coin1</code>, $0$ <code>Coin2</code>; Reserve: $40$ <code>Coin1</code>, $55$ <code>Coin2</code></p></li><li><p>&mldr;</p></li></ul><p>By repeating this process, a malicious user could drain almost all the tokens in the reserved accounts.</p><h3 id=exploit-contract-1>Exploit contract</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-rust data-lang=rust><span class=n>module</span><span class=w> </span><span class=n>solution</span>::<span class=n>solution3</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>signer</span><span class=p>;</span><span class=w>
</span><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>vector</span><span class=p>;</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>aptos_framework</span>::<span class=n>coin</span>::<span class=p>{</span><span class=n>Self</span><span class=p>,</span><span class=w> </span><span class=n>Coin</span><span class=p>};</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>ctfmovement</span>::<span class=n>pool</span>::<span class=p>{</span><span class=n>Self</span><span class=p>,</span><span class=w> </span><span class=n>Coin1</span><span class=p>,</span><span class=w> </span><span class=n>Coin2</span><span class=p>};</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=n>public</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=n>fun</span><span class=w> </span><span class=n>solve</span><span class=p>(</span><span class=n>account</span>: <span class=kp>&amp;</span><span class=nc>signer</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>        </span><span class=n>pool</span>::<span class=n>get_coin</span><span class=p>(</span><span class=n>account</span><span class=p>);</span><span class=w>
</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>coin2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>coin</span>::<span class=n>withdraw</span><span class=o>&lt;</span><span class=n>Coin2</span><span class=o>&gt;</span><span class=p>(</span><span class=n>account</span><span class=p>,</span><span class=w> </span><span class=mi>5</span><span class=p>);</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>coin1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pool</span>::<span class=n>swap_21</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>coin2</span><span class=p>,</span><span class=w> </span><span class=mi>5</span><span class=p>);</span><span class=w>
</span><span class=w>        </span><span class=n>coin</span>::<span class=n>deposit</span><span class=o>&lt;</span><span class=n>Coin2</span><span class=o>&gt;</span><span class=p>(</span><span class=n>signer</span>::<span class=n>address_of</span><span class=p>(</span><span class=n>account</span><span class=p>),</span><span class=w> </span><span class=n>coin2</span><span class=p>);</span><span class=w>
</span><span class=w>        </span><span class=n>coin</span>::<span class=n>deposit</span><span class=o>&lt;</span><span class=n>Coin1</span><span class=o>&gt;</span><span class=p>(</span><span class=n>signer</span>::<span class=n>address_of</span><span class=p>(</span><span class=n>account</span><span class=p>),</span><span class=w> </span><span class=n>coin1</span><span class=p>);</span><span class=w>
</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>coin1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>coin</span>::<span class=n>withdraw</span><span class=o>&lt;</span><span class=n>Coin1</span><span class=o>&gt;</span><span class=p>(</span><span class=n>account</span><span class=p>,</span><span class=w> </span><span class=mi>10</span><span class=p>);</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>coin2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pool</span>::<span class=n>swap_12</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>coin1</span><span class=p>,</span><span class=w> </span><span class=mi>10</span><span class=p>);</span><span class=w>
</span><span class=w>        </span><span class=n>coin</span>::<span class=n>deposit</span><span class=o>&lt;</span><span class=n>Coin2</span><span class=o>&gt;</span><span class=p>(</span><span class=n>signer</span>::<span class=n>address_of</span><span class=p>(</span><span class=n>account</span><span class=p>),</span><span class=w> </span><span class=n>coin2</span><span class=p>);</span><span class=w>
</span><span class=w>        </span><span class=n>coin</span>::<span class=n>deposit</span><span class=o>&lt;</span><span class=n>Coin1</span><span class=o>&gt;</span><span class=p>(</span><span class=n>signer</span>::<span class=n>address_of</span><span class=p>(</span><span class=n>account</span><span class=p>),</span><span class=w> </span><span class=n>coin1</span><span class=p>);</span><span class=w>
</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>coin2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>coin</span>::<span class=n>withdraw</span><span class=o>&lt;</span><span class=n>Coin2</span><span class=o>&gt;</span><span class=p>(</span><span class=n>account</span><span class=p>,</span><span class=w> </span><span class=mi>12</span><span class=p>);</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>coin1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pool</span>::<span class=n>swap_21</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>coin2</span><span class=p>,</span><span class=w> </span><span class=mi>12</span><span class=p>);</span><span class=w>
</span><span class=w>        </span><span class=n>coin</span>::<span class=n>deposit</span><span class=o>&lt;</span><span class=n>Coin2</span><span class=o>&gt;</span><span class=p>(</span><span class=n>signer</span>::<span class=n>address_of</span><span class=p>(</span><span class=n>account</span><span class=p>),</span><span class=w> </span><span class=n>coin2</span><span class=p>);</span><span class=w>
</span><span class=w>        </span><span class=n>coin</span>::<span class=n>deposit</span><span class=o>&lt;</span><span class=n>Coin1</span><span class=o>&gt;</span><span class=p>(</span><span class=n>signer</span>::<span class=n>address_of</span><span class=p>(</span><span class=n>account</span><span class=p>),</span><span class=w> </span><span class=n>coin1</span><span class=p>);</span><span class=w>
</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>coin1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>coin</span>::<span class=n>withdraw</span><span class=o>&lt;</span><span class=n>Coin1</span><span class=o>&gt;</span><span class=p>(</span><span class=n>account</span><span class=p>,</span><span class=w> </span><span class=mi>15</span><span class=p>);</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>coin2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pool</span>::<span class=n>swap_12</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>coin1</span><span class=p>,</span><span class=w> </span><span class=mi>15</span><span class=p>);</span><span class=w>
</span><span class=w>        </span><span class=n>coin</span>::<span class=n>deposit</span><span class=o>&lt;</span><span class=n>Coin2</span><span class=o>&gt;</span><span class=p>(</span><span class=n>signer</span>::<span class=n>address_of</span><span class=p>(</span><span class=n>account</span><span class=p>),</span><span class=w> </span><span class=n>coin2</span><span class=p>);</span><span class=w>
</span><span class=w>        </span><span class=n>coin</span>::<span class=n>deposit</span><span class=o>&lt;</span><span class=n>Coin1</span><span class=o>&gt;</span><span class=p>(</span><span class=n>signer</span>::<span class=n>address_of</span><span class=p>(</span><span class=n>account</span><span class=p>),</span><span class=w> </span><span class=n>coin1</span><span class=p>);</span><span class=w>
</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>coin2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>coin</span>::<span class=n>withdraw</span><span class=o>&lt;</span><span class=n>Coin2</span><span class=o>&gt;</span><span class=p>(</span><span class=n>account</span><span class=p>,</span><span class=w> </span><span class=mi>20</span><span class=p>);</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>coin1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pool</span>::<span class=n>swap_21</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>coin2</span><span class=p>,</span><span class=w> </span><span class=mi>20</span><span class=p>);</span><span class=w>
</span><span class=w>        </span><span class=n>coin</span>::<span class=n>deposit</span><span class=o>&lt;</span><span class=n>Coin2</span><span class=o>&gt;</span><span class=p>(</span><span class=n>signer</span>::<span class=n>address_of</span><span class=p>(</span><span class=n>account</span><span class=p>),</span><span class=w> </span><span class=n>coin2</span><span class=p>);</span><span class=w>
</span><span class=w>        </span><span class=n>coin</span>::<span class=n>deposit</span><span class=o>&lt;</span><span class=n>Coin1</span><span class=o>&gt;</span><span class=p>(</span><span class=n>signer</span>::<span class=n>address_of</span><span class=p>(</span><span class=n>account</span><span class=p>),</span><span class=w> </span><span class=n>coin1</span><span class=p>);</span><span class=w>
</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>coin1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>coin</span>::<span class=n>withdraw</span><span class=o>&lt;</span><span class=n>Coin1</span><span class=o>&gt;</span><span class=p>(</span><span class=n>account</span><span class=p>,</span><span class=w> </span><span class=mi>24</span><span class=p>);</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>coin2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pool</span>::<span class=n>swap_12</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>coin1</span><span class=p>,</span><span class=w> </span><span class=mi>24</span><span class=p>);</span><span class=w>
</span><span class=w>        </span><span class=n>coin</span>::<span class=n>deposit</span><span class=o>&lt;</span><span class=n>Coin2</span><span class=o>&gt;</span><span class=p>(</span><span class=n>signer</span>::<span class=n>address_of</span><span class=p>(</span><span class=n>account</span><span class=p>),</span><span class=w> </span><span class=n>coin2</span><span class=p>);</span><span class=w>
</span><span class=w>        </span><span class=n>coin</span>::<span class=n>deposit</span><span class=o>&lt;</span><span class=n>Coin1</span><span class=o>&gt;</span><span class=p>(</span><span class=n>signer</span>::<span class=n>address_of</span><span class=p>(</span><span class=n>account</span><span class=p>),</span><span class=w> </span><span class=n>coin1</span><span class=p>);</span><span class=w>
</span><span class=w>
</span><span class=w>        </span><span class=n>pool</span>::<span class=n>get_flag</span><span class=p>(</span><span class=n>account</span><span class=p>);</span><span class=w>
</span><span class=w>    </span><span class=p>}</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></td></tr></table></div></div><h3 id=possible-fix>Possible fix</h3><p>One possible fix is to use the following formula to calculate the number of tokens that can be exchanged, to ensure that the product of the two token amounts is always constant:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-rust data-lang=rust><span class=n>public</span><span class=w> </span><span class=n>fun</span><span class=w> </span><span class=n>get_amouts_out</span><span class=p>(</span><span class=n>pool</span>: <span class=kp>&amp;</span><span class=nc>LiquidityPool</span><span class=p>,</span><span class=w> </span><span class=n>amount</span>: <span class=kt>u64</span><span class=p>,</span><span class=w> </span><span class=n>order</span>: <span class=kt>bool</span><span class=p>)</span>: <span class=kt>u64</span> <span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=p>(</span><span class=n>token1</span><span class=p>,</span><span class=w> </span><span class=n>token2</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>get_amounts</span><span class=p>(</span><span class=n>pool</span><span class=p>);</span><span class=w>
</span><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>order</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>amount</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>token2</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=p>(</span><span class=n>token1</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w>
</span><span class=w>    </span><span class=p>}</span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>amount</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>token1</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=p>(</span><span class=n>token2</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>amount</span><span class=p>)</span><span class=w>
</span><span class=w>    </span><span class=p>}</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></td></tr></table></div></div><h2 id=challenge-4-simple-swap>Challenge 4: simple swap</h2><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>Challenge Info<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content><ul><li>Source: <a href=https://github.com/movebit/ctfmovement-4>https://github.com/movebit/ctfmovement-4</a></li><li>Link: http://47.243.227.164:20003/web/</li><li>Score: 300</li></ul></div></div></div><h3 id=target-contract-3>Target contract</h3><p>This contract implements a Uniswap v2 like coin swap program that allows users to swap between <code>TestUSDC</code> and <code>SimpleCoin</code> with a $0.25%$ fee rate and a $0.1%$ bonus if a user swaps <code>TestUSDC</code> to <code>SimpleCoin</code>. In the initialization process, the admin added $10^{10}$ <code>TestUSDC</code> and $10^{10}$ <code>SimpleCoin</code> to the pool. The <code>get_flag</code> function will check if the user has at least $10^{10}$ <code>SimpleCoin</code>, if so, the user will get the flag.</p><h3 id=vulnerability-1>Vulnerability</h3><p>There are two vulnerabilities in this contract.</p><ul><li>The first vulnerability is that there is no limit on the amount of tokens that a user can claim via airdrop. An attacker can claim a large amount of tokens and then swap them to other tokens to drain the reserve pool.</li><li>The second vulnerability is that the <code>swap_exact_x_to_y_direct</code> and <code>swap_exact_y_to_x_direct</code> functions are incorrectly exposed to the public. An attacker can call this function to swap tokens without paying the fee.</li></ul><p>Combining these two vulnerabilities, an attacker could first claim a large amount of <code>TestUSDC</code> and then swap an amount of <code>TestUSDC</code> equal to the current reserve pool for <code>SimpleCoin</code> each time to drain half of the reserve pool while receiving a $0.1%$ bonus. After $n$ repetitions, the amount of <code>SimpleCoin</code> in the reserve pool will be reduced to $10^{10}\cdot\frac{1}{2^n}$.</p><h3 id=exploit-contract-2>Exploit contract</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-rust data-lang=rust><span class=n>module</span><span class=w> </span><span class=n>solution</span>::<span class=n>solution4</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>signer</span><span class=p>;</span><span class=w>
</span><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>vector</span><span class=p>;</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>ctfmovement</span>::<span class=n>simple_coin</span>::<span class=p>{</span><span class=n>Self</span><span class=p>,</span><span class=w> </span><span class=n>SimpleCoin</span><span class=p>,</span><span class=w> </span><span class=n>CoinCap</span><span class=p>,</span><span class=w> </span><span class=n>TestUSDC</span><span class=p>};</span><span class=w>
</span><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>ctfmovement</span>::<span class=n>swap</span>::<span class=p>{</span><span class=n>Self</span><span class=p>,</span><span class=w> </span><span class=n>LPCoin</span><span class=p>};</span><span class=w>
</span><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>aptos_framework</span>::<span class=n>coin</span>::<span class=p>{</span><span class=n>Self</span><span class=p>,</span><span class=w> </span><span class=n>BurnCapability</span><span class=p>,</span><span class=w> </span><span class=n>MintCapability</span><span class=p>,</span><span class=w> </span><span class=n>FreezeCapability</span><span class=p>,</span><span class=w> </span><span class=n>Coin</span><span class=p>};</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=n>public</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=n>fun</span><span class=w> </span><span class=n>solve</span><span class=p>(</span><span class=n>account</span>: <span class=kp>&amp;</span><span class=nc>signer</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>
</span><span class=w>        </span><span class=n>simple_coin</span>::<span class=n>claim_faucet</span><span class=p>(</span><span class=n>account</span><span class=p>,</span><span class=w> </span><span class=mi>1000000000000000000</span><span class=p>);</span><span class=w>
</span><span class=w>        </span><span class=n>swap</span>::<span class=n>check_or_register_coin_store</span><span class=o>&lt;</span><span class=n>SimpleCoin</span><span class=o>&gt;</span><span class=p>(</span><span class=n>account</span><span class=p>);</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>base</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>10000000000</span><span class=p>;</span><span class=w> 
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>20</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>tusdc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>coin</span>::<span class=n>withdraw</span><span class=o>&lt;</span><span class=n>TestUSDC</span><span class=o>&gt;</span><span class=p>(</span><span class=n>account</span><span class=p>,</span><span class=w> </span><span class=n>base</span><span class=p>);</span><span class=w>
</span><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=p>(</span><span class=n>simple_coin</span><span class=p>,</span><span class=w> </span><span class=n>simple_coin_reward</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>swap</span>::<span class=n>swap_exact_y_to_x_direct</span><span class=o>&lt;</span><span class=n>SimpleCoin</span><span class=p>,</span><span class=w> </span><span class=n>TestUSDC</span><span class=o>&gt;</span><span class=p>(</span><span class=n>tusdc</span><span class=p>);</span><span class=w>
</span><span class=w>            </span><span class=n>coin</span>::<span class=n>deposit</span><span class=o>&lt;</span><span class=n>SimpleCoin</span><span class=o>&gt;</span><span class=p>(</span><span class=n>signer</span>::<span class=n>address_of</span><span class=p>(</span><span class=n>account</span><span class=p>),</span><span class=w> </span><span class=n>simple_coin</span><span class=p>);</span><span class=w>
</span><span class=w>            </span><span class=n>coin</span>::<span class=n>deposit</span><span class=o>&lt;</span><span class=n>SimpleCoin</span><span class=o>&gt;</span><span class=p>(</span><span class=n>signer</span>::<span class=n>address_of</span><span class=p>(</span><span class=n>account</span><span class=p>),</span><span class=w> </span><span class=n>simple_coin_reward</span><span class=p>);</span><span class=w>
</span><span class=w>            </span><span class=n>base</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>base</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w>
</span><span class=w>            </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span><span class=w>        </span><span class=p>};</span><span class=w>
</span><span class=w>
</span><span class=w>        </span><span class=n>simple_coin</span>::<span class=n>get_flag</span><span class=p>(</span><span class=n>account</span><span class=p>);</span><span class=w>
</span><span class=w>    </span><span class=p>}</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></td></tr></table></div></div><h3 id=possible-fix-1>Possible fix</h3><ul><li>Add a limit to the airdrop amount each account can claim</li><li>Remove the <code>public</code> visibility modifier of the <code>swap_exact_x_to_y_direct&lt;X, Y></code> function to make it private</li></ul><h2 id=challenge-5-move-lock-v2>Challenge 5: move lock v2</h2><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>Challenge Info<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content><ul><li>Source: <a href=https://github.com/movebit/ctfmovement-5>https://github.com/movebit/ctfmovement-5</a></li><li>Link: http://47.243.227.164:20004/web/</li><li>Score: 400</li></ul></div></div></div><h3 id=target-contract-4>Target contract</h3><p>This contract generate a number by using a polynomial whose coefficients are generated by a string encrypted with script hash and several pseudo-random numbers. Flag event will be emitted if the user guesses the correct number. Obviously, it is almost impossible to guess the correct number, since the number of possible guesses is $2^{128}$.</p><h3 id=vulnerability-2>Vulnerability</h3><p>The vulnerability is that the pesudorandom number is generated with a timestamp in seconds and a counter. The counter is initialized to $0$ and will be increased by $1$ each time a random number is generated. Therefore, both the timestamp and the counter are predictable. An attacker can just reuse most of the code in the target contract to generate a same polynomial and the correct number directly. Recall that the string is encrypted by XORing script hash and a constant, we need to call the exploit contract via a script.</p><h3 id=exploit-contract-3>Exploit contract</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-rust data-lang=rust><span class=n>module</span><span class=w> </span><span class=n>solution</span>::<span class=n>solution5</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=c1>//
</span><span class=c1></span><span class=w>    </span><span class=c1>// [*] Dependencies
</span><span class=c1></span><span class=w>    </span><span class=c1>//
</span><span class=c1></span><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>aptos_framework</span>::<span class=n>transaction_context</span><span class=p>;</span><span class=w>
</span><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>aptos_framework</span>::<span class=n>timestamp</span><span class=p>;</span><span class=w>
</span><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>aptos_framework</span>::<span class=n>account</span><span class=p>;</span><span class=w>
</span><span class=w>    </span><span class=c1>// use aptos_framework::event;
</span><span class=c1></span><span class=w>
</span><span class=w>    </span><span class=c1>// use aptos_std::debug;
</span><span class=c1></span><span class=w>    
</span><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>vector</span><span class=p>;</span><span class=w>
</span><span class=w>    </span><span class=c1>// use std::signer;
</span><span class=c1></span><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>hash</span><span class=p>;</span><span class=w>
</span><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>bcs</span><span class=p>;</span><span class=w>    
</span><span class=w>    
</span><span class=w>    </span><span class=c1>//
</span><span class=c1></span><span class=w>    </span><span class=c1>// [*] Structures
</span><span class=c1></span><span class=w>    </span><span class=c1>//
</span><span class=c1></span><span class=w>    </span><span class=k>struct</span> <span class=nc>Polynomial</span><span class=w> </span><span class=n>has</span><span class=w> </span><span class=n>drop</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>        </span><span class=n>degree</span><span class=w> </span>: <span class=kt>u64</span><span class=p>,</span><span class=w>
</span><span class=w>        </span><span class=n>coefficients</span><span class=w> </span>: <span class=nc>vector</span><span class=o>&lt;</span><span class=kt>u8</span><span class=o>&gt;</span><span class=w>
</span><span class=w>    </span><span class=p>}</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=k>struct</span> <span class=nc>Counter</span><span class=w> </span><span class=n>has</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>        </span><span class=n>value</span><span class=w> </span>: <span class=kt>u64</span>
    <span class=p>}</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>ctfmovement</span>::<span class=n>move_lock</span><span class=p>;</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=k>const</span><span class=w> </span><span class=n>BASE</span><span class=w> </span>: <span class=nc>vector</span><span class=o>&lt;</span><span class=kt>u8</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>b&#34;HoudiniWhoHoudiniMeThatsHoudiniWho&#34;</span><span class=p>;</span><span class=w>
</span><span class=w>    
</span><span class=w>    </span><span class=c1>//
</span><span class=c1></span><span class=w>    </span><span class=c1>// [*] Module Initialization 
</span><span class=c1></span><span class=w>    </span><span class=c1>//
</span><span class=c1></span><span class=w>    </span><span class=n>fun</span><span class=w> </span><span class=n>init_module</span><span class=p>(</span><span class=n>creator</span>: <span class=kp>&amp;</span><span class=nc>signer</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>        </span><span class=n>move_to</span><span class=p>(</span><span class=n>creator</span><span class=p>,</span><span class=w> </span><span class=n>Counter</span><span class=p>{</span><span class=w> </span><span class=n>value</span>: <span class=mi>0</span><span class=w> </span><span class=p>})</span><span class=w>
</span><span class=w>    </span><span class=p>}</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=n>public</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=n>fun</span><span class=w> </span><span class=n>solve</span><span class=p>(</span><span class=n>account</span>: <span class=kp>&amp;</span><span class=nc>signer</span><span class=p>)</span>: <span class=kt>bool</span> <span class=nc>acquires</span><span class=w> </span><span class=n>Counter</span><span class=w>  </span><span class=p>{</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>encrypted_string</span><span class=w> </span>: <span class=nc>vector</span><span class=o>&lt;</span><span class=kt>u8</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>encrypt_string</span><span class=p>(</span><span class=n>BASE</span><span class=p>);</span><span class=w>
</span><span class=w>        
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>res_addr</span><span class=w> </span>: <span class=nc>address</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>account</span>::<span class=n>create_resource_address</span><span class=p>(</span><span class=o>&amp;@</span><span class=n>ctfmovement</span><span class=p>,</span><span class=w> </span><span class=n>encrypted_string</span><span class=p>);</span><span class=w>
</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>bys_addr</span><span class=w> </span>: <span class=nc>vector</span><span class=o>&lt;</span><span class=kt>u8</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bcs</span>::<span class=n>to_bytes</span><span class=p>(</span><span class=o>&amp;</span><span class=n>res_addr</span><span class=p>);</span><span class=w>
</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>cof</span><span class=w> </span>: <span class=nc>vector</span><span class=o>&lt;</span><span class=kt>u8</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>vector</span>::<span class=n>empty</span><span class=o>&lt;</span><span class=kt>u8</span><span class=o>&gt;</span><span class=p>();</span><span class=w>
</span><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>vector</span>::<span class=n>length</span><span class=p>(</span><span class=o>&amp;</span><span class=n>bys_addr</span><span class=p>)</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>
</span><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>n1</span><span class=w> </span>: <span class=kt>u64</span> <span class=o>=</span><span class=w> </span><span class=n>gen_number</span><span class=p>()</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=p>(</span><span class=mh>0xff</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u64</span><span class=p>);</span><span class=w>
</span><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>n2</span><span class=w> </span>: <span class=kt>u8</span> <span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>n1</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u8</span><span class=p>);</span><span class=w>
</span><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>tmp</span><span class=w> </span>: <span class=kt>u8</span> <span class=o>=</span><span class=w> </span><span class=o>*</span><span class=n>vector</span>::<span class=n>borrow</span><span class=p>(</span><span class=o>&amp;</span><span class=n>bys_addr</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>);</span><span class=w>
</span><span class=w>
</span><span class=w>            </span><span class=n>vector</span>::<span class=n>push_back</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>cof</span><span class=p>,</span><span class=w> </span><span class=n>n2</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=p>(</span><span class=n>tmp</span><span class=p>));</span><span class=w>
</span><span class=w>
</span><span class=w>            </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>5</span><span class=p>;</span><span class=w>
</span><span class=w>            </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span><span class=w>        </span><span class=p>};</span><span class=w>
</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>pol</span><span class=w> </span>: <span class=nc>Polynomial</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>constructor</span><span class=p>(</span><span class=n>d</span><span class=p>,</span><span class=w> </span><span class=n>cof</span><span class=p>);</span><span class=w>
</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>x</span><span class=w> </span>: <span class=kt>u64</span> <span class=o>=</span><span class=w> </span><span class=n>gen_number</span><span class=p>()</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=mh>0xff</span><span class=p>;</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>evaluate</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>pol</span><span class=p>,</span><span class=w> </span><span class=n>x</span><span class=p>);</span><span class=w>
</span><span class=w>        
</span><span class=w>        </span><span class=n>move_lock</span>::<span class=n>unlock</span><span class=p>(</span><span class=n>account</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>)</span><span class=w>
</span><span class=w>    </span><span class=p>}</span><span class=w>
</span><span class=w>    
</span><span class=w>    </span><span class=c1>//
</span><span class=c1></span><span class=w>    </span><span class=c1>// [*] Local functions
</span><span class=c1></span><span class=w>    </span><span class=c1>//
</span><span class=c1></span><span class=w>    </span><span class=n>fun</span><span class=w> </span><span class=n>increment</span><span class=p>()</span>: <span class=kt>u64</span> <span class=nc>acquires</span><span class=w> </span><span class=n>Counter</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>c_ref</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>borrow_global_mut</span><span class=o>&lt;</span><span class=n>Counter</span><span class=o>&gt;</span><span class=p>(</span><span class=o>@</span><span class=n>solution</span><span class=p>).</span><span class=n>value</span><span class=p>;</span><span class=w>
</span><span class=w>        </span><span class=o>*</span><span class=n>c_ref</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>*</span><span class=n>c_ref</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span><span class=w>        </span><span class=o>*</span><span class=n>c_ref</span><span class=w>
</span><span class=w>    </span><span class=p>}</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=n>fun</span><span class=w> </span><span class=n>constructor</span><span class=p>(</span><span class=w> </span><span class=n>_degree</span><span class=w> </span>: <span class=kt>u64</span><span class=p>,</span><span class=w> </span><span class=n>_coefficients</span><span class=w> </span>: <span class=nc>vector</span><span class=o>&lt;</span><span class=kt>u8</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>: <span class=nc>Polynomial</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>        </span><span class=n>Polynomial</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>            </span><span class=n>degree</span><span class=w> </span>: <span class=nc>_degree</span><span class=p>,</span><span class=w>
</span><span class=w>            </span><span class=n>coefficients</span><span class=w> </span>: <span class=nc>_coefficients</span><span class=w>
</span><span class=w>        </span><span class=p>}</span><span class=w>
</span><span class=w>    </span><span class=p>}</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=n>fun</span><span class=w> </span><span class=n>pow</span><span class=p>(</span><span class=n>n</span>: <span class=kt>u64</span><span class=p>,</span><span class=w> </span><span class=n>e</span>: <span class=kt>u64</span><span class=p>)</span>: <span class=kt>u64</span> <span class=p>{</span><span class=w>
</span><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>e</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>            </span><span class=mi>1</span><span class=w>
</span><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>e</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>            </span><span class=n>n</span><span class=w>
</span><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pow</span><span class=p>(</span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mi>2</span><span class=p>);</span><span class=w>
</span><span class=w>            </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>p</span><span class=p>;</span><span class=w>
</span><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>e</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>                </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>n</span><span class=p>;</span><span class=w>
</span><span class=w>                </span><span class=n>p</span><span class=w>
</span><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>                </span><span class=n>p</span><span class=w>
</span><span class=w>            </span><span class=p>}</span><span class=w>
</span><span class=w>        </span><span class=p>}</span><span class=w>
</span><span class=w>    </span><span class=p>}</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=n>fun</span><span class=w> </span><span class=n>evaluate</span><span class=p>(</span><span class=n>p</span><span class=w> </span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>Polynomial</span><span class=p>,</span><span class=w> </span><span class=n>x</span><span class=w> </span>: <span class=kt>u64</span><span class=p>)</span><span class=w> </span>: <span class=nc>u128</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>result</span><span class=w> </span>: <span class=nc>u128</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>i</span><span class=w> </span>: <span class=kt>u64</span> <span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span><span class=w>
</span><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=n>degree</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>            </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(((</span><span class=o>*</span><span class=n>vector</span>::<span class=n>borrow</span><span class=p>(</span><span class=o>&amp;</span><span class=n>p</span><span class=p>.</span><span class=n>coefficients</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u64</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>pow</span><span class=p>(</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>))</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u128</span><span class=p>);</span><span class=w>
</span><span class=w>            </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span><span class=w>        </span><span class=p>};</span><span class=w>
</span><span class=w>
</span><span class=w>        </span><span class=n>result</span><span class=w>
</span><span class=w>    </span><span class=p>}</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=n>fun</span><span class=w> </span><span class=n>seed</span><span class=p>()</span>: <span class=nc>vector</span><span class=o>&lt;</span><span class=kt>u8</span><span class=o>&gt;</span><span class=w> </span><span class=n>acquires</span><span class=w> </span><span class=n>Counter</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>counter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>increment</span><span class=p>();</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>counter_bytes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bcs</span>::<span class=n>to_bytes</span><span class=p>(</span><span class=o>&amp;</span><span class=n>counter</span><span class=p>);</span><span class=w>
</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>timestamp</span>: <span class=kt>u64</span> <span class=o>=</span><span class=w> </span><span class=n>timestamp</span>::<span class=n>now_seconds</span><span class=p>();</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>timestamp_bytes</span>: <span class=nc>vector</span><span class=o>&lt;</span><span class=kt>u8</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bcs</span>::<span class=n>to_bytes</span><span class=p>(</span><span class=o>&amp;</span><span class=n>timestamp</span><span class=p>);</span><span class=w>
</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>data</span>: <span class=nc>vector</span><span class=o>&lt;</span><span class=kt>u8</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>vector</span>::<span class=n>empty</span><span class=o>&lt;</span><span class=kt>u8</span><span class=o>&gt;</span><span class=p>();</span><span class=w>
</span><span class=w>        </span><span class=n>vector</span>::<span class=n>append</span><span class=o>&lt;</span><span class=kt>u8</span><span class=o>&gt;</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=n>counter_bytes</span><span class=p>);</span><span class=w>
</span><span class=w>        </span><span class=n>vector</span>::<span class=n>append</span><span class=o>&lt;</span><span class=kt>u8</span><span class=o>&gt;</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=n>timestamp_bytes</span><span class=p>);</span><span class=w>
</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>hash</span>: <span class=nc>vector</span><span class=o>&lt;</span><span class=kt>u8</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>hash</span>::<span class=n>sha3_256</span><span class=p>(</span><span class=n>data</span><span class=p>);</span><span class=w>
</span><span class=w>        </span><span class=n>hash</span><span class=w>
</span><span class=w>    </span><span class=p>}</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=n>fun</span><span class=w> </span><span class=n>get_u64</span><span class=p>(</span><span class=n>bytes</span>: <span class=nc>vector</span><span class=o>&lt;</span><span class=kt>u8</span><span class=o>&gt;</span><span class=p>)</span>: <span class=kt>u64</span> <span class=p>{</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=k>u64</span><span class=p>;</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=k>u64</span><span class=p>;</span><span class=w>
</span><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>8</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>            </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=p>((</span><span class=o>*</span><span class=n>vector</span>::<span class=n>borrow</span><span class=p>(</span><span class=o>&amp;</span><span class=n>bytes</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u64</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=p>((</span><span class=mi>8</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=p>(</span><span class=mi>7</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>i</span><span class=p>))</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u8</span><span class=p>));</span><span class=w>
</span><span class=w>            </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span><span class=w>        </span><span class=p>};</span><span class=w>
</span><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>value</span><span class=w>
</span><span class=w>    </span><span class=p>}</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=n>fun</span><span class=w> </span><span class=n>gen_number</span><span class=p>()</span><span class=w> </span>: <span class=kt>u64</span> <span class=nc>acquires</span><span class=w> </span><span class=n>Counter</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>_seed</span>: <span class=nc>vector</span><span class=o>&lt;</span><span class=kt>u8</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>seed</span><span class=p>();</span><span class=w>
</span><span class=w>        </span><span class=n>get_u64</span><span class=p>(</span><span class=n>_seed</span><span class=p>)</span><span class=w>
</span><span class=w>    </span><span class=p>}</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=n>fun</span><span class=w> </span><span class=n>encrypt_string</span><span class=p>(</span><span class=n>plaintext</span><span class=w> </span>: <span class=nc>vector</span><span class=o>&lt;</span><span class=kt>u8</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>: <span class=nc>vector</span><span class=o>&lt;</span><span class=kt>u8</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>key</span><span class=w> </span>: <span class=nc>vector</span><span class=o>&lt;</span><span class=kt>u8</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>transaction_context</span>::<span class=n>get_script_hash</span><span class=p>();</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>key_len</span><span class=w> </span>: <span class=kt>u64</span> <span class=o>=</span><span class=w> </span><span class=n>vector</span>::<span class=n>length</span><span class=p>(</span><span class=o>&amp;</span><span class=n>key</span><span class=p>);</span><span class=w>
</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>ciphertext</span><span class=w> </span>: <span class=nc>vector</span><span class=o>&lt;</span><span class=kt>u8</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>vector</span>::<span class=n>empty</span><span class=o>&lt;</span><span class=kt>u8</span><span class=o>&gt;</span><span class=p>();</span><span class=w>
</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>vector</span>::<span class=n>length</span><span class=p>(</span><span class=o>&amp;</span><span class=n>plaintext</span><span class=p>)</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>            </span><span class=n>vector</span>::<span class=n>push_back</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>ciphertext</span><span class=p>,</span><span class=w> </span><span class=o>*</span><span class=n>vector</span>::<span class=n>borrow</span><span class=p>(</span><span class=o>&amp;</span><span class=n>plaintext</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=o>*</span><span class=n>vector</span>::<span class=n>borrow</span><span class=p>(</span><span class=o>&amp;</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>key_len</span><span class=p>)));</span><span class=w>
</span><span class=w>            </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span><span class=w>        </span><span class=p>};</span><span class=w>
</span><span class=w>
</span><span class=w>        </span><span class=n>ciphertext</span><span class=w>
</span><span class=w>    </span><span class=p>}</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></td></tr></table></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2022-12-14</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://leoq7.com/2022/12/CTF-Movement-Aptos/ data-title="CTF MOVEment with Aptos Dec 2022 Writeup" data-via=LeoQ7_ data-hashtags=Web3,CTF,Move><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://leoq7.com/2022/12/CTF-Movement-Aptos/ data-hashtag=Web3><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://leoq7.com/2022/12/CTF-Movement-Aptos/ data-title="CTF MOVEment with Aptos Dec 2022 Writeup"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://leoq7.com/2022/12/CTF-Movement-Aptos/ data-title="CTF MOVEment with Aptos Dec 2022 Writeup"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@6.20.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on " data-sharer=weibo data-url=https://leoq7.com/2022/12/CTF-Movement-Aptos/ data-title="CTF MOVEment with Aptos Dec 2022 Writeup"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/Web3/>Web3</a>,&nbsp;<a href=/tags/CTF/>CTF</a>,&nbsp;<a href=/tags/Move/>Move</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/2022/12/PBCTF-Move-VM/ class=prev rel=prev title="PBCTF 2023 Move VM Writeup"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>PBCTF 2023 Move VM Writeup</a></div></div><div id=comments><div id=utterances class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2020 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Qi Qin</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery@2.4.0/css/lightgallery-bundle.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.1/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.4.0/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.4.0/plugins/thumbnail/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.4.0/plugins/zoom/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/contrib/auto-render.min.js></script><script type=text/javascript>window.config={code:{maxShownLines:50},comment:{utterances:{darkTheme:"github-dark",issueTerm:"og:title",label:"",lightTheme:"github-light",repo:"LeoQ7/LeoQ7-comments"}},lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>